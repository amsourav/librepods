# A simple GitHub Actions workflow to build a release AAB or APK on tag push or manual dispatch.
# It expects these repository secrets:
# - KEYSTORE_BASE64    (base64 of your release.jks)
# - KEYSTORE_PASSWORD
# - KEY_ALIAS
# - KEY_PASSWORD
# Adjust sdk packages / ndk versions to your needs.

name: Android Release Build
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: /usr/local/android-sdk
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Android SDK tools
        run: |
          sudo mkdir -p $ANDROID_SDK_ROOT
          curl -sS https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -o cmdline-tools.zip
          sudo unzip -q cmdline-tools.zip -d $ANDROID_SDK_ROOT
          sudo mkdir -p $ANDROID_SDK_ROOT/cmdline-tools/latest
          sudo mv $ANDROID_SDK_ROOT/cmdline-tools/* $ANDROID_SDK_ROOT/cmdline-tools/latest/
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=${ANDROID_SDK_ROOT} "platform-tools" "platforms;android-33" "build-tools;33.0.2" "cmake;3.22.1" "ndk;21.4.7075529"
      - name: Show Gradlew wrapper
        run: ls -la android/gradlew

      - name: Decode keystore
        if: secrets.KEYSTORE_BASE64 != ''
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/release.jks

      - name: Build release bundle
        working-directory: android
        run: |
          chmod +x ./gradlew
          ./gradlew :app:bundleRelease \
            -Pandroid.injected.signing.store.file=../android/release.jks \
            -Pandroid.injected.signing.store.password="${{ secrets.KEYSTORE_PASSWORD }}" \
            -Pandroid.injected.signing.key.alias="${{ secrets.KEY_ALIAS }}" \
            -Pandroid.injected.signing.key.password="${{ secrets.KEY_PASSWORD }}"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-bundle
          path: android/app/build/outputs/bundle/release/*.aab